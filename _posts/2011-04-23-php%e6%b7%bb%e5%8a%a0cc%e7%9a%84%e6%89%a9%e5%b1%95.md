---
id: 64
title: php添加c/c++的扩展
date: 2011-04-23T16:16:38+00:00
author: dawei
layout: post
guid: http://bookwikiup.com/blog/?p=64
permalink: /2011/04/23/php%e6%b7%bb%e5%8a%a0cc%e7%9a%84%e6%89%a9%e5%b1%95/
categories:
  - 未分类
---
某个功能被编译到so文件中，那么如何通过php来调用它？一个方法是写一个php模块(php extension)，在php中调用该模块内的函数，再通过该模块来调用so中的函数。下面做一个简单的例子，使用的操作系统是Fedora Core 6。   
首先做一个简单的so文件：   
/**   
* hello.c   
* To compile, use following commands:   
* gcc -O -c -fPIC -o hello.o hello.c   
* gcc -shared -o libhello.so hello.o   
*/   
int hello_add(int a, int b)   
{   
return a + b;   
}   
然后将它编译成.so文件并放到系统中：   
$ gcc -O -c -fPIC -o hello.o hello.c   
$ gcc -shared -o libhello.so hello.o   
$ su   
\# echo /usr/local/lib > /etc/ld.so.conf.d/local.conf   
\# cp libhello.so /usr/local/lib   
\# /sbin/ldconfig写段小程序来验证其正确性：   
/**   
* hellotest.c   
* To compile, use following commands:   
* gcc -o hellotest -lhello hellotest.c   
*/   
#include   
int main()   
{   
int a = 3, b = 4;   
printf("%d + %d = %dn", a, b, hello_add(a,b));   
return 0;   
}   
编译并执行：   
$ gcc -o hellotest -lhello hellotest.c   
$ ./hellotest   
3 + 4 = 7OK，   
下面我们来制作PHP模块。首先确保你安装了 php-devel 包，没有的话请自行从安装光盘上找。然后下载php源代码。我使用的是php-5.2.9.tar.gz，解压缩。   
$ tar xzvf php-5.2.9.tar.gz   
$ cd php-5.2.9/ext然后通过下面的命令建立一个名为 test 的模块。   
$ ./ext\_skel &#8211;extname=test执行该命令之后它会提示你应当用什么命令来编译模块，可惜那是将模块集成到php内部的编译方法。如果要编译成可动态加载的 php\_test.so，方法要更为简单。   
$ cd test首先编辑 config.m4 文件，去掉第16行和第18行的注释（注释符号为 dnl 。）   
16: PHP\_ARG\_ENABLE(test, whether to enable test support,   
17: dnl Make sure that the comment is aligned:   
18: [ --enable-test Enable test support])然后执行 phpize ()程序，生成configure脚本：  
数声明：   
PHP\_FUNCTION(confirm\_hello_compiled); /\* For testing, remove later. \*/   
PHP\_FUNCTION(test\_add);打开 hello.c，在 PHP\_FE(confirm\_test_compiled, NULL) 下方加入以下内容。   
zend\_function\_entry test_functions[] = {   
PHP\_FE(confirm\_test_compiled, NULL) /\* For testing, remove later. \*/   
PHP\_FE(test\_add, NULL) /\* For testing, remove later. \*/   
{NULL, NULL, NULL} /\* Must be the last line in test_functions[] \*/   
};   
然后在 test.c 的最末尾书写test_add函数的内容：   
PHP\_FUNCTION(test\_add)   
{   
long int a, b;   
long int result;   
if (zend\_parse\_parameters(ZEND\_NUM\_ARGS() TSRMLS_CC, "ll", &a, &b) == FAILURE) {   
return;   
}   
result = test_add(a, b);   
RETURN_LONG(result);   
}   
保存退出，编译并安装：   
$ ./configure &#8211;enable-jinzhesheng_module &#8211;with-apxs=/usr/local/apache/bin/apxs &#8211;with-php-config=/usr/local/php/bin/php-config$ make   
\# cp modules/test.so /usr/lib/php/modules然后在 /www/web/ 下建立一个 test.php 文件，内容如下：   
dl("test.so");   
echo test_add(1, 2);   
?>