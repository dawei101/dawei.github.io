---
id: 38
title: MySQL 游标
date: 2011-08-01T12:49:57+00:00
author: dawei
layout: post
guid: http://bookwikiup.com/blog/?p=38
permalink: /2011/08/01/mysql-%e6%b8%b8%e6%a0%87/
categories:
  - 未分类
---
比较基础的  
可以用在存储过程的SQL语句主要有以下类型:  
1、 无返回结果语句，如：INSERT,UPDATE,DROP, DELETE等  
2、 select语句返回单行变量并可传给本地变量(select ..into)  
3、 返回多行结果集的select语句,并可使用游标循环处理   
注意，存储过程返回的多行结果集，可以被客户端程序（如php）所接收,但要在一个存储过程中接收另一个存储过程的结果集是不可能的，一般解决办法是存入临时表供其它过程共用。  
4、 prepare语句

以下主要讲述游标及prepare部分

游标  
定义  
DECLARE cursor\_name CURSOR FOR SELECT\_statement;

游标操作  
OPEN 打开游标   
OPEN cursor_name;  
FETCH 获取游标当前指针的记录，并传给指定变量列表,注意变量数必须与游标返回的字段数一致,要获得多行数据，使用循环语句去执行FETCH   
FETCH cursor_name INTO variable list;

CLOSE关闭游标  
CLOSE cursor_name ;  
注意:mysql的游标是向前只读的,也就是说，你只能顺序地从开始往后读取结果集，不能从后往前，也不能直接跳到中间的记录.  
一个完整的例子:   
&#8212; 定义本地变量   
DECLARE o varchar(128);   
&#8212; 定义游标   
DECLARE ordernumbers CURSOR   
FOR   
SELECT callee\_name FROM account\_tbl where acct_timeduration=10800;   
DECLARE CONTINUE HANDLER FOR NOT FOUND SET no\_more\_departments=1;   
SET no\_more\_departments=0;

&#8212; 打开游标   
OPEN ordernumbers;   
&#8212; 循环所有的行   
REPEAT   
&#8212; Get order number   
FETCH ordernumbers INTO o;   
update account set allMoney=allMoney+72,lastMonthConsume=lastMonthConsume-72 where NumTg=@o;

&#8212; 循环结束   
UNTIL no\_more\_departments   
END REPEAT;   
&#8212; 关闭游标   
CLOSE ordernumbers;